generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model prov {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String?
}

model audit_log {
  id         Int      @id @default(autoincrement())
  user_id    Int?
  action     String   @db.VarChar(50)
  entity     String   @db.VarChar(100)
  entity_id  Int
  old_data   Json?    @db.JsonB
  new_data   Json?    @db.JsonB
  created_at DateTime @default(now()) @db.Timestamptz(6)
  user       user?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
   @@map("audit_log")
}

model county {
  id         Int        @id @default(autoincrement())
  state_id   Int
  name       String     @db.VarChar(40)
  code       String     @db.Char(3)
  created_at DateTime   @default(now()) @db.Timestamptz(6)
  updated_at DateTime   @default(now()) @db.Timestamptz(6)
  state      state      @relation(fields: [state_id], references: [id], map: "fk_county_state")
  customer   customer[]

  @@unique([state_id, name], map: "uq_county_name_per_state")
  @@index([state_id], map: "idx_county_state_id")
}

model customer {
  id               Int       @id @default(autoincrement())
  nit              String    @unique(map: "uq_customer_nit") @db.VarChar(20)
  first_name       String    @db.VarChar(50)
  middle_name      String?   @db.VarChar(50)
  last_name        String    @db.VarChar(50)
  second_last_name String?   @db.VarChar(50)
  email            String?   @unique(map: "uq_customer_email") @db.VarChar(120)
  phone            String?   @db.VarChar(30)
  address          String?   @db.VarChar(150)
  county_id        Int
  created_at       DateTime  @default(now()) @db.Timestamptz(6)
  updated_at       DateTime  @default(now()) @db.Timestamptz(6)
  county           county    @relation(fields: [county_id], references: [id], map: "fk_customer_county")
  invoice          invoice[]

  @@index([county_id], map: "idx_customer_county")
}

model invoice {
  id          Int      @id @default(autoincrement())
  customer_id Int
  total       Decimal  @db.Decimal(14, 2)
  status      String   @db.VarChar(20)
  created_by  Int
  created_at  DateTime @default(now()) @db.Timestamp(6)
  user        user     @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  customer    customer @relation(fields: [customer_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model permission {
  id              Int               @id @default(autoincrement())
  code            String            @unique @db.VarChar(100)
  description     String?
  created_at      DateTime          @default(now()) @db.Timestamp(6)
  role_permission role_permission[]
}

model role {
  id              Int               @id @default(autoincrement())
  name            String            @unique @db.VarChar(50)
  description     String?
  created_at      DateTime          @default(now()) @db.Timestamp(6)
  role_permission role_permission[]
  user_role       user_role[]
}

model role_permission {
  role_id       Int
  permission_id Int
  created_at    DateTime   @default(now()) @db.Timestamp(6)
  permission    permission @relation(fields: [permission_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  role          role       @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([role_id, permission_id])
}

model state {
  id         Int      @id @default(autoincrement())
  name       String   @unique(map: "uq_state_name") @db.VarChar(40)
  code       String   @unique(map: "uq_state_code") @db.Char(2)
  created_at DateTime @default(now()) @db.Timestamp(6)
  updated_at DateTime @default(now()) @db.Timestamp(6)
  county     county[]

  @@index([name], map: "idx_state_name")
}

model user {
  id            Int         @id @default(autoincrement())
  username      String      @unique @db.VarChar(50)
  email         String      @unique @db.VarChar(150)
  password_hash String
  full_name     String      @db.VarChar(150)
  is_active     Boolean     @default(true)
  created_at    DateTime    @default(now()) @db.Timestamp(6)
  audit_log     audit_log[]
  invoice       invoice[]
  user_role     user_role[]
}

model user_role {
  user_id    Int
  role_id    Int
  created_at DateTime @default(now()) @db.Timestamp(6)
  role       role     @relation(fields: [role_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user       user     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([user_id, role_id])
}
